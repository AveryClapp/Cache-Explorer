name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        llvm: [18, 19, 20, 21]

    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh ${{ matrix.llvm }}
          sudo apt-get install -y clang-${{ matrix.llvm }} llvm-${{ matrix.llvm }}-dev

      - name: Install LLVM (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm@${{ matrix.llvm }}
          echo "/opt/homebrew/opt/llvm@${{ matrix.llvm }}/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y ninja-build cmake jq bc libboost-system-dev
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install ninja cmake jq bc boost
          fi

      - name: Build cache simulator
        run: |
          rm -rf backend/cache-simulator/build
          mkdir -p backend/cache-simulator/build
          cd backend/cache-simulator/build
          cmake .. -G Ninja
          ninja

      - name: Build runtime library
        run: |
          rm -rf backend/runtime/build
          mkdir -p backend/runtime/build
          cd backend/runtime/build
          cmake .. -G Ninja
          ninja

      - name: Build LLVM pass
        run: |
          # Clean build directory to avoid stale artifacts
          rm -rf backend/llvm-pass/build
          mkdir -p backend/llvm-pass/build
          cd backend/llvm-pass/build

          # Set environment to use correct LLVM version
          if [ "$RUNNER_OS" == "Linux" ]; then
            export PATH="/usr/lib/llvm-${{ matrix.llvm }}/bin:$PATH"
            export CC="/usr/lib/llvm-${{ matrix.llvm }}/bin/clang"
            export CXX="/usr/lib/llvm-${{ matrix.llvm }}/bin/clang++"
            export LD_LIBRARY_PATH="/usr/lib/llvm-${{ matrix.llvm }}/lib:$LD_LIBRARY_PATH"
            cmake .. -G Ninja \
              -DLLVM_DIR=/usr/lib/llvm-${{ matrix.llvm }}/lib/cmake/llvm \
              -DCMAKE_PREFIX_PATH=/usr/lib/llvm-${{ matrix.llvm }}
          else
            export PATH="/opt/homebrew/opt/llvm@${{ matrix.llvm }}/bin:$PATH"
            export CC="/opt/homebrew/opt/llvm@${{ matrix.llvm }}/bin/clang"
            export CXX="/opt/homebrew/opt/llvm@${{ matrix.llvm }}/bin/clang++"
            cmake .. -G Ninja \
              -DLLVM_DIR=/opt/homebrew/opt/llvm@${{ matrix.llvm }}/lib/cmake/llvm \
              -DCMAKE_PREFIX_PATH=/opt/homebrew/opt/llvm@${{ matrix.llvm }}
          fi

          # Verify LLVM version
          echo "Building with:"
          $CC --version | head -1

          ninja

      - name: Fix macOS SDK path (if needed)
        if: runner.os == 'macOS'
        run: |
          SDK_PATH=$(xcrun --show-sdk-path)
          mkdir -p /opt/homebrew/etc/clang
          echo "-isysroot $SDK_PATH" > /opt/homebrew/etc/clang/$(uname -m)-apple-darwin$(uname -r | cut -d. -f1).cfg || true

      - name: Run integration tests
        run: |
          # Set environment to use the correct LLVM version
          if [ "$RUNNER_OS" == "Linux" ]; then
            export PATH="/usr/lib/llvm-${{ matrix.llvm }}/bin:$PATH"
            export CACHE_EXPLORER_CC="/usr/lib/llvm-${{ matrix.llvm }}/bin/clang"
            export CACHE_EXPLORER_CXX="/usr/lib/llvm-${{ matrix.llvm }}/bin/clang++"
          else
            export PATH="/opt/homebrew/opt/llvm@${{ matrix.llvm }}/bin:$PATH"
            export CACHE_EXPLORER_CC="/opt/homebrew/opt/llvm@${{ matrix.llvm }}/bin/clang"
            export CACHE_EXPLORER_CXX="/opt/homebrew/opt/llvm@${{ matrix.llvm }}/bin/clang++"
          fi
          cd tests/integration
          ./run-all-tests.sh

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-llvm${{ matrix.llvm }}
          path: tests/integration/*.log
          if-no-files-found: ignore
